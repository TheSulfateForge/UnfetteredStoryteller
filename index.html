<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Unfettered Storyteller</title>
    <meta charset="UTF-8" />
    <meta
      name="description"
      content="A TTRPG style RPG Storyteller, powered by Gemini."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./index.css" />
    <link rel="manifest" href="./manifest.json" />
    <link rel="apple-touch-icon" href="./UFST-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Lato:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^0.14.0",
    "react/": "https://esm.sh/react@^19.1.0/",
    "react": "https://esm.sh/react@^19.1.0"
  }
}
</script>
    <script type="module" src="./index.js"></script>
  </head>
  <body>
    <!-- LANDING PAGE -->
    <div id="landing-page">
        <p id="version-display" class="version-info"></p>
        <h1>Unfettered Storyteller</h1>
        <div class="landing-actions">
            <button id="landing-new-btn">New Adventure</button>
            <button id="landing-load-btn">Load Adventure</button>
            <button id="landing-settings-btn">Settings</button>
        </div>
        <div class="landing-footer">
            <p id="landing-credit-line" class="credit"></p>
            <button id="legal-btn">LEGAL</button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="settings-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2>Settings</h2>
        <form id="settings-form">
          <div class="form-group">
            <label for="provider-selector">AI Provider</label>
            <select id="provider-selector">
              <option value="gemini">Google Gemini</option>
              <option value="local">Local LLM</option>
            </select>
          </div>
          
          <div id="gemini-settings-section">
            <div class="form-group">
              <label for="api-key-input">Google AI API Key</label>
              <input type="password" id="api-key-input" placeholder="Enter your Google AI key here">
              <p class="form-hint">Get one free from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer">Google AI Studio</a>. Your key is stored only in your browser.</p>
            </div>
          </div>
          
          <div id="local-llm-settings-section" class="hidden">
            <div class="form-group">
              <label for="local-llm-url-input">Local LLM URL</label>
              <input type="url" id="local-llm-url-input" placeholder="e.g., http://127.0.0.1:5000/v1/chat/completions">
              <p class="form-hint">Enter the full chat completions endpoint for your local server (e.g., Ollama with OpenAI compatibility).</p>
            </div>
          </div>
          
          <div class="form-group" id="rag-section">
            <label>Knowledge Base (RAG)</label>
            <p class="form-hint">Build a local knowledge base from TTRPG sourcebooks for more accurate answers. This can take several minutes and requires a Gemini API key.</p>
            <div id="rag-status" class="form-hint">Status: Not initialized</div>
            <button type="button" id="build-rag-btn" class="secondary" style="margin-top: 0.5rem;" disabled>Build Knowledge Base</button>
          </div>

          <div class="modal-actions">
              <button type="submit">Save Settings</button>
          </div>
        </form>
      </div>
    </div>

    <div id="age-gate-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2>Welcome to Unfettered Storyteller</h2>
        <p>This experience is intended for mature audiences and may contain themes of violence, intrigue, and—if enabled—erotic role-play (18+).</p>
        <p>By clicking "Accept", you confirm you are 18 years of age or older and consent to engaging with this content.</p>
        <div class="modal-settings">
          <label for="age-gate-mature-toggle" class="toggle-label">Enable Mature Content (18+)</label>
          <label class="switch">
            <input type="checkbox" id="age-gate-mature-toggle" />
            <span class="slider round"></span>
          </label>
        </div>
        <button id="age-gate-accept">Accept</button>
      </div>
    </div>

    <div id="load-game-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2>Your Adventures</h2>
            <div id="save-slots-list">
                <!-- Save slots will be dynamically injected here -->
            </div>
            <div class="modal-actions">
                <button id="new-adventure-btn">Start a New Adventure</button>
                <button id="load-game-cancel-btn" class="secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="character-creation-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2>Create Your Character</h2>
        <p>Define your hero to the Storyteller. This will shape your journey.</p>
        <form id="character-form">
            <div class="form-scroll-container">
                <div class="form-group">
                    <label for="char-name">Character Name</label>
                    <input type="text" id="char-name" required placeholder="e.g., Kaelen d'Rivis">
                </div>
                <div class="form-group">
                    <label for="char-desc">Appearance & Description</label>
                    <textarea id="char-desc" rows="3" placeholder="e.g., A tall human with intricate tattoos, wearing a worn traveler's cloak."></textarea>
                </div>
                <div class="form-group">
                    <label for="char-bio">Backstory & Bio</label>
                    <textarea id="char-bio" rows="4" placeholder="e.g., A former soldier haunted by the last war, now seeking answers in the shadows of the city."></textarea>
                </div>
                
                <!-- START: New Point Buy Section -->
                <div class="point-buy-section">
                    <div class="point-buy-header">
                        <h4>Ability Scores (Point Buy)</h4>
                        <div class="points-display">
                            Points Remaining: <span id="points-remaining">35</span>
                        </div>
                    </div>
                    <div id="point-buy-container" class="point-buy-grid">
                        <!-- Strength -->
                        <div class="stat-row">
                            <label>Strength</label>
                            <div class="stat-controls">
                                <button type="button" class="stat-btn" id="str-decrease" data-stat="strength">-</button>
                                <span class="stat-score" id="strength-score">10</span>
                                <button type="button" class="stat-btn" id="str-increase" data-stat="strength">+</button>
                            </div>
                            <div class="stat-cost">Cost: <span id="strength-cost">0</span></div>
                        </div>
                        <!-- Dexterity -->
                        <div class="stat-row">
                            <label>Dexterity</label>
                            <div class="stat-controls">
                                <button type="button" class="stat-btn" id="dex-decrease" data-stat="dexterity">-</button>
                                <span class="stat-score" id="dexterity-score">10</span>
                                <button type="button" class="stat-btn" id="dex-increase" data-stat="dexterity">+</button>
                            </div>
                            <div class="stat-cost">Cost: <span id="dexterity-cost">0</span></div>
                        </div>
                        <!-- Constitution -->
                        <div class="stat-row">
                            <label>Constitution</label>
                            <div class="stat-controls">
                                <button type="button" class="stat-btn" id="con-decrease" data-stat="constitution">-</button>
                                <span class="stat-score" id="constitution-score">10</span>
                                <button type="button" class="stat-btn" id="con-increase" data-stat="constitution">+</button>
                            </div>
                            <div class="stat-cost">Cost: <span id="constitution-cost">0</span></div>
                        </div>
                        <!-- Intelligence -->
                        <div class="stat-row">
                            <label>Intelligence</label>
                            <div class="stat-controls">
                                <button type="button" class="stat-btn" id="int-decrease" data-stat="intelligence">-</button>
                                <span class="stat-score" id="intelligence-score">10</span>
                                <button type="button" class="stat-btn" id="int-increase" data-stat="intelligence">+</button>
                            </div>
                            <div class="stat-cost">Cost: <span id="intelligence-cost">0</span></div>
                        </div>
                        <!-- Wisdom -->
                        <div class="stat-row">
                            <label>Wisdom</label>
                            <div class="stat-controls">
                                <button type="button" class="stat-btn" id="wis-decrease" data-stat="wisdom">-</button>
                                <span class="stat-score" id="wisdom-score">10</span>
                                <button type="button" class="stat-btn" id="wis-increase" data-stat="wisdom">+</button>
                            </div>
                            <div class="stat-cost">Cost: <span id="wisdom-cost">0</span></div>
                        </div>
                        <!-- Charisma -->
                        <div class="stat-row">
                            <label>Charisma</label>
                            <div class="stat-controls">
                                <button type="button" class="stat-btn" id="cha-decrease" data-stat="charisma">-</button>
                                <span class="stat-score" id="charisma-score">10</span>
                                <button type="button" class="stat-btn" id="cha-increase" data-stat="charisma">+</button>
                            </div>
                            <div class="stat-cost">Cost: <span id="charisma-cost">0</span></div>
                        </div>
                    </div>
                </div>
                <!-- END: New Point Buy Section -->

                <!-- TTRPG CHARACTER CREATION INPUTS START HERE -->
                <div class="form-group">
                    <label for="char-race">Race</label>
                    <select id="char-race" required>
                        <option value="" disabled selected>Select a Race...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="char-class">Class</label>
                    <select id="char-class" required>
                        <option value="" disabled selected>Select a Class...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="char-background">Background</label>
                    <select id="char-background" required>
                        <option value="" disabled selected>Select a Background...</option>
                    </select>
                </div>
                
                <!-- START: New Master Skill Section -->
                <div id="skill-selection-section" class="skill-section">
                    <h4 class="skill-section-header">Skill Proficiencies</h4>
                    <div id="skill-selection-container">
                        <!-- The script will dynamically render all skill choices here -->
                    </div>
                </div>
                <!-- END: New Master Skill Section -->

                <div class="form-group">
                    <label for="char-alignment">Alignment</label>
                    <select id="char-alignment" required>
                        <option value="" disabled selected>Select an Alignment...</option>
                        <option value="Lawful Good">Lawful Good</option>
                        <option value="Lawful Neutral">Lawful Neutral</option>
                        <option value="Lawful Evil">Lawful Evil</option>
                        <option value="Neutral Good">Neutral Good</option>
                        <option value="True Neutral">True Neutral</option>
                        <option value="Neutral Evil">Neutral Evil</option>
                        <option value="Chaotic Good">Chaotic Good</option>
                        <option value="Chaotic Neutral">Chaotic Neutral</option>
                        <option value="Chaotic Evil">Chaotic Evil</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="char-gender">Gender</label>
                    <select id="char-gender" required>
                        <option value="" disabled selected>Select a Gender...</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                    </select>
                </div>
            </div>
            <!-- TTRPG CHARACTER CREATION INPUTS END HERE -->
            <div class="modal-actions">
                <button type="submit">Create Character</button>
                <button type="button" id="character-creation-cancel-btn" class="secondary">Cancel</button>
            </div>
        </form>
      </div>
    </div>

    <div id="story-hooks-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2>Choose Your Adventure</h2>
        <p>The Storyteller offers three paths. Which will you take? Or will you forge your own?</p>
        <div id="story-hooks-container">
          <!-- Spinner or hooks will be injected here -->
        </div>
        <div class="custom-hook-section">
          <h3>...Or Write Your Own Beginning</h3>
          <form id="custom-hook-form">
            <textarea id="custom-hook-input" rows="3" placeholder="e.g., I wake up in an alley with no memory, a strange symbol tattooed on my hand..."></textarea>
            <button type="submit">Start with This</button>
          </form>
        </div>
      </div>
    </div>
    
    <div id="legal-modal" class="modal-overlay hidden">
        <div id="legal-modal-content" class="modal-content">
            <span id="legal-modal-close-btn" class="modal-close-btn">×</span>
            <h2>Legal Notices & Licenses</h2>
        
            <div class="legal-section">
                <h3>Application Code</h3>
                <p>
                    The original source code for this application is an independent work of authorship by TheSulfateForge and is licensed under the 
                    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer">Creative Commons Attribution-NonCommercial 4.0 International License</a>.
                </p>
                <p>
                    You can view the full license for the application's code here: 
                    <a href="./LICENSES/LICENSE-CODE.md" target="_blank">LICENSE-CODE.md</a>
                </p>
            </div>
        
            <div class="legal-section">
                <h3>Game Data & Systems Reference Document</h3>
                <p>
                    This work includes material taken from the System Reference Document 5.1 (“SRD 5.1”) by Wizards of the Coast LLC and available at <a href="https://dnd.wizards.com/resources/systems-reference-document" target="_blank" rel="noopener noreferrer">https://dnd.wizards.com/resources/systems-reference-document</a>. The SRD 5.1 is licensed under the Open Game License v 1.0a.
                </p>
                <p>
                    Much of the game data used in this application (monsters, spells, classes, etc.) is sourced from the <a href="https://open5e.com/" target="_blank" rel="noopener noreferrer">Open5e project</a>, which is also provided under the OGL 1.0a.
                </p>
                <p>
                    A full copy of the required Open Game License can be viewed here:
                    <a href="./LICENSES/LICENSE-SRD.md" target="_blank">LICENSE-SRD.md</a>
                </p>
            </div>
            
            <hr>
            <p class="disclaimer">
                This work is not affiliated with, endorsed, sponsored, or specifically approved by Wizards of the Coast LLC.
            </p>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <h2 id="confirm-modal-title">Confirm Action</h2>
        <p id="confirm-modal-text">Are you sure?</p>
        <div class="modal-actions">
            <button id="confirm-modal-yes-btn">Confirm</button>
            <button id="confirm-modal-no-btn" class="secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app" class="hidden">
      <aside id="player-stats">
        <div class="stats-header">
          <h2 id="stats-char-name">Character</h2>
          <p id="stats-location">Unknown</p>
        </div>

        <div class="accordion-section">
            <h3 class="accordion-header active">Vitals & Status</h3>
            <div class="accordion-content expanded">
                <div class="stat-item">
                    <label>Health</label>
                    <span id="stats-health">--/--</span>
                </div>
                <div class="stat-item">
                    <label>Money</label>
                    <span id="stats-money">--</span>
                </div>
                <div class="stat-item">
                    <label>Experience</label>
                    <span id="stats-exp">--</span>
                </div>
                <div id="stats-pregnancy-status" class="stat-item hidden">
                    <label>Condition</label>
                    <span id="stats-pregnancy-value">--</span>
                </div>
            </div>
        </div>

        <div class="accordion-section">
            <h3 class="accordion-header">Equipment & Inventory</h3>
            <div class="accordion-content">
                <h4>Equipment</h4>
                <ul id="stats-equipment">
                    <li><strong>Weapon:</strong> <span id="equip-weapon">None</span></li>
                    <li><strong>Armor:</strong> <span id="equip-armor">None</span></li>
                </ul>
                <h4>Inventory</h4>
                <ul id="stats-inventory">
                    <li>(Empty)</li>
                </ul>
            </div>
        </div>

        <div class="accordion-section">
            <h3 class="accordion-header">Quests & Party</h3>
            <div class="accordion-content">
                <h4>Quests</h4>
                <ul id="stats-quests">
                    <li>(None)</li>
                </ul>
                <h4>Party</h4>
                <ul id="stats-party">
                    <li>(None)</li>
                </ul>
            </div>
        </div>

        <div class="accordion-section">
            <h3 class="accordion-header">Character Sheet</h3>
            <div class="accordion-content">
                <p>Level: <span id="stats-level"></span></p>
                <p>Proficiency Bonus: <span id="stats-proficiency-bonus"></span></p>
                <p>Armor Class (AC): <span id="stats-ac"></span></p>
                <p>Speed: <span id="stats-speed"></span> ft.</p>
                <p>Race: <span id="stats-race"></span></p>
                <p>Class: <span id="stats-class"></span></p>
                <p>Background: <span id="stats-background"></span></p>
                <p>Alignment: <span id="stats-alignment"></span></p>
            </div>
        </div>

        <div class="accordion-section">
            <h3 class="accordion-header">Ability Scores</h3>
            <div class="accordion-content">
                <ul id="stats-ability-scores">
                    <li>Strength: <span id="stats-str"></span> (<span id="stats-str-mod"></span>)</li>
                    <li>Dexterity: <span id="stats-dex"></span> (<span id="stats-dex-mod"></span>)</li>
                    <li>Constitution: <span id="stats-con"></span> (<span id="stats-con-mod"></span>)</li>
                    <li>Intelligence: <span id="stats-int"></span> (<span id="stats-int-mod"></span>)</li>
                    <li>Wisdom: <span id="stats-wis"></span> (<span id="stats-wis-mod"></span>)</li>
                    <li>Charisma: <span id="stats-cha"></span> (<span id="stats-cha-mod"></span>)</li>
                </ul>
            </div>
        </div>

        <div class="accordion-section">
            <h3 class="accordion-header">Skills</h3>
            <div class="accordion-content">
                <ul id="stats-skills"></ul>
            </div>
        </div>
        
        <div class="accordion-section">
            <h3 class="accordion-header">Saving Throws</h3>
            <div class="accordion-content">
                <ul id="stats-saving-throws"></ul>
            </div>
        </div>
        
        <div class="accordion-section">
            <h3 class="accordion-header">Features & Traits</h3>
            <div class="accordion-content">
                <h4>Feats</h4>
                <ul id="stats-feats"></ul>
                <h4>Racial Traits</h4>
                <ul id="stats-racial-traits"></ul>
                <h4>Class Features</h4>
                <ul id="stats-class-features"></ul>
            </div>
        </div>
      </aside>
      
      <div id="main-content">
        <div id="app-overlay"></div>
        <header>
          <div class="header-main">
            <button id="sidebar-toggle-btn" class="sidebar-toggle" aria-label="Toggle Character Sheet">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            <h1>Unfettered Storyteller</h1>
            <p>Your adventure in the world of magic and mystery awaits.</p>
          </div>
          <div class="settings">
            <button id="change-settings-btn" class="settings-btn" title="Change Settings">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17-.59-1.69-.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59-1.69-.98l2.49 1c.23.08.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
              <span>Settings</span>
            </button>
            <!--
            <button id="debug-log-btn" class="settings-btn" title="Toggle Debug Log">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5s-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c.45.78 1.07 1.45 1.82 1.96L7 19.59 8.41 21l2.17-2.17c.45.11.92.17 1.41.17s.96-.06 1.41-.17L15.59 21 17 19.59l-1.62-1.63c.75-.51 1.37-1.18 1.82-1.96H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/></svg>
                <span>Debug Log</span>
            </button>
            -->
            <label for="read-aloud-toggle" class="toggle-label">Read Aloud</label>
            <label class="switch">
              <input type="checkbox" id="read-aloud-toggle" />
              <span class="slider round"></span>
            </label>
          </div>
        </header>
        <main id="chat-container">
          <div id="chat-log" role="log" aria-live="polite"></div>
          <div id="loading" class="hidden">
            <div class="spinner"></div>
            <span>The storyteller is thinking...</span>
          </div>
        </main>
        <!--
        <div id="debugger-panel" class="hidden">
            <h3>AI Debug Log</h3>
            <div class="debugger-section">
                <h4>Last Input to AI</h4>
                <pre id="debug-input">No input captured yet.</pre>
            </div>
            <div class="debugger-section">
                <h4>Last Raw AI Response</h4>
                <pre id="debug-output">No response captured yet.</pre>
            </div>
        </div>
        -->
        <footer>
          <form id="chat-form">
            <button type="button" id="mic-btn" aria-label="Use microphone">
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
            </button>
            <textarea
              id="chat-input"
              placeholder="What do you do?"
              aria-label="Your action"
              autocomplete="off"
              rows="2"
            ></textarea>
            <button type="submit" aria-label="Send action">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                width="24"
                height="24"
              >
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
              </svg>
            </button>
          </form>
        </footer>
      </div>
    </div>
  </body>
</html>
